#' Assign operations using gps and observer or OGT operations diary.
#'
#' Fishing diary can be generated by an observer,by create_diary_from_ogt
#' function or by captains log.
#' For diaries to work, some columns need to be present:
#' Fecha
#' fec_cal
#' ini_largada
#' fin_largada
#' fec_vir
#' ini_virada
#' fin_virada
#'
#
#'
#' These columns will be automatically generated if create_diary_from_ogt is
#' used, so make sure that these columns are present in the file if the log file
#' is created by an observer. On ly dates and times are needed, no positions
#' have to be included on this file.
#' @param gps_file File where the gps data is.
#' @param log_file File with the diary info.
#' @param timezone Defaults to UTC.
#' @param log_source Defines where diary data comes from. Options are "obs"
#' for observer, "ogt" for OGTs and "log" for captains log. Defaults to "obs".
#' @return returns a gps file but with fishing operations marked in a new
#' column named SI_FOPER and values ST (Steaming), SE (Setting), HA (Hauling)
#' and WT (Waiting), SI_FSTATUS marked as TRUE or FALSE and the corresponding
#' SU_ISOB, SI_OGT or SI_LOG filled where TRUE.
#' @importFrom stringr str_remove_all str_split str_extract
#' @importFrom dplyr %>% mutate select left_join case_when if_else rename relocate group_by ungroup
#' @importFrom purrr map_dbl map2
#' @importFrom sf st_sfc st_point st_as_sf
#' @export
gps_match_oper <- function(gps_file, log_file, timezone = "UTC", log_source = "obs") {

  # Read files
  gps_data <- read_file(gps_file)
  log_data <- read_file(log_file)

  # if gps_file is CSV, convert 'geometry' column to a geometric object
  if ("geometry" %in% names(gps_data)) {
    gps_data <- gps_data %>%
      # Cleam geometry' column to extract numeric values
      mutate(geometry = str_remove_all(geometry, "[c\\(\\)]"),  # Remove "c(" and ")"
             lon_lat = str_split(geometry, ", ")) %>%  # Split in longitude and latitude
      # Convert coordinates to numeric values and create POINT geomtries
      mutate(lon = map_dbl(lon_lat, ~ as.numeric(.x[1])),  # Extract longitude
             lat = map_dbl(lon_lat, ~ as.numeric(.x[2])),  # Extract latitude
             geometry = st_sfc(map2(lon, lat, ~st_point(c(.x, .y))), crs = 4326)) %>%
      select(-lon_lat, -lon, -lat)  # Delete temp longitude and latitude columns
  }

  # Make sure it is an sf object
  gps_data <- st_as_sf(gps_data)


  # Convert SI_TIMESTAMP to POSIXct format and create SI_DATE in gps_data
  gps_data <- gps_data %>%
    mutate(SI_TIMESTAMP = as.POSIXct(SI_TIMESTAMP, format="%Y-%m-%d %H:%M:%S", tz = timezone),
           SI_DATE = as.Date(SI_TIMESTAMP, tz = timezone))

  # Convert log_data columns to POSIXct
  log_data <- log_data %>%
    mutate(
      Fecha = as.Date(Fecha, format="%Y-%m-%d"),
      fec_cal = as.Date(fec_cal, format="%Y-%m-%d"),
      fec_vir = as.Date(fec_vir, format="%Y-%m-%d"),
      ini_largada = as.POSIXct(paste(fec_cal, ini_largada), format="%Y-%m-%d %H:%M", tz = timezone),
      fin_largada = as.POSIXct(paste(fec_cal, fin_largada), format="%Y-%m-%d %H:%M", tz = timezone),
      ini_virada = as.POSIXct(paste(fec_vir, ini_virada), format="%Y-%m-%d %H:%M", tz = timezone),
      fin_virada = as.POSIXct(paste(fec_vir, fin_virada), format="%Y-%m-%d %H:%M", tz = timezone)
    )

  # Combine gps_data with log_data using VE_REF and SI_DATE
  combined_data <- gps_data %>%
    left_join(log_data, by = c("VE_REF" = "CFR", "SI_DATE" = "Fecha"))

  # Assignar values to LE_MET4 and LE_MET6 based on GEAR
  combined_data <- combined_data %>%
    mutate(
      LE_MET4 = case_when(
        is.na(LE_MET4) & nchar(GEAR) <= 5 ~ GEAR,
        is.na(LE_MET4) & nchar(GEAR) > 5 ~ str_extract(GEAR, "^[^_]+"),
        TRUE ~ LE_MET4
      ),
      LE_MET6 = case_when(
        is.na(LE_MET6) & nchar(GEAR) > 5 ~ GEAR,
        TRUE ~ LE_MET6
      )
    )

  # Create SI_FOPER and SI_FSTATUS based on conditions
  combined_data <- combined_data %>%
    # Verify if 'Marea' exists and create 'grouping_var' conditionally
    {
      if ("Marea" %in% names(.)) {
        mutate(., grouping_var = if_else(!is.na(FT_REF), FT_REF, Marea),
               FT_REF = if_else(is.na(FT_REF), Marea, FT_REF))
      } else {
        mutate(., grouping_var = FT_REF)  # If 'Marea' does not exist, use only 'FT_REF'
      }
    } %>%
    # If 'Lance' exists, rename to 'FT_LA' and move, if not, create empty 'FT_LA'
    {
      if ("Lance" %in% names(.)) {
        rename(., FT_LA = Lance) %>%  # Rename'Lance' to 'FT_LA'
          relocate(FT_LA, .after = FT_REF) %>%  # Move 'FT_LA' after 'FT_REF'
          group_by(., VE_REF, grouping_var, FT_LA)  # group by FT_LA
      } else {
        mutate(., FT_LA = NA) %>%  # Create empty 'FT_LA' if 'Lance' does not exist
          relocate(FT_LA, .after = FT_REF) %>%  # Move 'FT_LA' after 'FT_REF'
          group_by(., VE_REF, grouping_var)  # group without FT_LA
      }
    } %>%
    # Create Operations
    mutate(
      SI_FOPER = case_when(
        is.na(ini_largada) | is.na(fin_largada) | is.na(ini_virada) | is.na(fin_virada) ~ "UN",
        SI_TIMESTAMP < ini_largada ~ "ST",
        SI_TIMESTAMP >= ini_largada & SI_TIMESTAMP <= fin_largada ~ "SE",
        SI_TIMESTAMP > fin_largada & SI_TIMESTAMP < ini_virada ~ "WT",
        SI_TIMESTAMP >= ini_virada & SI_TIMESTAMP <= fin_virada ~ "HA",
        SI_TIMESTAMP > fin_virada ~ "ST",
        TRUE ~ "UN"
      ),
      SI_FSTATUS = if_else(SI_FOPER %in% c("SE", "HA", "WT"), "TRUE", "FALSE")
    ) %>%
    ungroup() %>%
    # Mark columns based on `log_source`
    mutate(
      SU_ISOB = if_else(log_source == "obs" & !is.na(ini_largada), TRUE, SU_ISOB),
      SI_OGT = if_else(log_source == "ogt" & !is.na(ini_largada), TRUE, SI_OGT),
      SI_LOG = if_else(log_source == "log" & !is.na(ini_largada), TRUE, SI_LOG)
    ) %>%
    select(-tail(names(.), 12))  # Delete unnecessary columns

  # Return final result
  return(combined_data)
}
